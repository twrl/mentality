!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("dexie")):"function"==typeof define&&define.amd?define(["dexie"],n):e.Dexie.Observable=n(e.Dexie)}(this,function(e){"use strict";function n(c){function u(t){n.latestRevision[c.name]<t&&(n.latestRevision[c.name]=t,e.ignoreTransaction(function(){n.on("latestRevisionIncremented").fire(c.name,t)}),T.setItem("Dexie.Observable/latestRevision/"+c.name,t))}function d(t){var i=t.name;t.hook("creating").subscribe(function(o,a,r){var s=void 0;void 0===o&&t.schema.primKey.uuid&&(o=s=n.createUUID(),t.schema.primKey.keyPath&&e.setByKeyPath(a,t.schema.primKey.keyPath,o));var l={source:r.source||null,table:i,key:void 0===o?null:o,type:O,obj:a},c=r.tables._changes.add(l).then(function(e){return r._lastWrittenRevision=Math.max(r._lastWrittenRevision,e),e});return this.onsuccess=function(e){o!=e&&c._then(function(){l.key=e,r.tables._changes.put(l)})},this.onerror=function(e){c._then(function(e){r.tables._changes["delete"](e)})},s}),t.hook("updating").subscribe(function(n,t,o,a){var r={},s=!1,l=e.deepClone(o);for(var c in n){var u=n[c];if("undefined"==typeof u)e.delByKeyPath(l,c),r[c]=null,s=!0;else{var d=e.getByKeyPath(o,c);u!==d&&JSON.stringify(u)!==JSON.stringify(d)&&(e.setByKeyPath(l,c,u),r[c]=u,s=!0)}}if(s){var m={source:a.source||null,table:i,key:t,type:w,mods:r,oldObj:o,obj:l},f=a.tables._changes.add(m);this.onsuccess=function(){f._then(function(e){a._lastWrittenRevision=Math.max(a._lastWrittenRevision,e)})},this.onerror=function(e){f._then(function(e){a.tables._changes["delete"](e)})}}}),t.hook("deleting").subscribe(function(e,n,t){var o=t.tables._changes.add({source:t.source||null,table:i,key:e,type:S,oldObj:n}).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e});this.onerror=function(){o._then(function(e){t.tables._changes["delete"](e)})}})}function m(n,t){if(n===c.name){if(I>=t)return;I=t,e.vip(function(){f(t)["catch"]("DatabaseClosedError",function(e){})})}}function f(e,t,i){if(!t&&f.ongoingOperation)return f.ongoingOperation;var a=!1,r=j;if(!r)return s.reject("Database closed");var u=1e3,d=c._changes.where("rev").above(r.myRevision).limit(u).toArray(function(e){if(e.length>0){var n=e[e.length-1];a=e.length===u,c.on("changes").fire(e,a),r.myRevision=n.rev}else i&&c.on("changes").fire([],!1);return c.table("_syncNodes").update(r,{lastHeartBeat:Date.now(),deleteTimeStamp:null,myRevision:r.myRevision})}).then(function(e){if(!e)throw l?new Error("Browser is shutting down"):(c.close(),console.error("Out of sync"),o.location&&o.location.reload(!0),new Error("Out of sync"));return a||n.latestRevision[c.name]>r.myRevision?f(n.latestRevision[c.name],(t||0)+1,a):void 0})["finally"](function(){delete f.ongoingOperation});return t||(f.ongoingOperation=d),d}function v(){B=null;var t=j.id;e.vip(function(){f(n.latestRevision[c.name]).then(y).then(b)["catch"]("DatabaseClosedError",function(e){})["finally"](function(){j&&j.id===t&&(B=setTimeout(v,N))})})}function y(){var t=j;return t?c.transaction("rw","_syncNodes","_changes","_intercomm",function(){var i=!1;c._syncNodes.where("lastHeartBeat").below(Date.now()-x).and(function(e){return"local"===e.type}).modify(function(n){n.deleteTimeStamp&&n.deleteTimeStamp<Date.now()?(delete this.value,T.removeItem("Dexie.Observable/deadnode:"+n.id+"/"+c.name),n.isMaster&&(c._syncNodes.update(t,{isMaster:1}),i=!0),c._intercomm.where("destinationNode").equals(n.id).modify(function(n){delete this.value,n.wantReply&&e.ignoreTransaction(function(){g(n)})})):n.deleteTimeStamp||(n.deleteTimeStamp=Date.now()+R)}).then(function(){return n.deleteOldChanges(c),c.on("cleanup").fire(i)})}):s.reject("Database closed")}function p(e){j&&(l=!0,j.deleteTimeStamp=1,j.lastHeartBeat=0,c._syncNodes.put(j),n.wereTheOneDying=!0,T.setItem("Dexie.Observable/deadnode:"+j.id.toString()+"/"+c.name,"dead"))}function h(t,i){t!==c.name||n.wereTheOneDying||e.vip(function(){c._syncNodes.update(i,{deleteTimeStamp:1,lastHeartBeat:0}).then(y)})}function b(){return j?c.table("_intercomm").where("destinationNode").equals(j.id).modify(function(n){delete this.value,e.ignoreTransaction(function(){g(n)})}):s.reject("Database closed")}function g(n){if("response"===n.type){var t=C[n.requestId.toString()];t&&(n.isFailure?t.reject(n.message.error):t.resolve(n.message.result),delete C[n.requestId.toString()])}else{n.resolve=function(e){c.sendMessage("response",{result:e},n.sender,{requestId:n.id})},n.reject=function(e){c.sendMessage("response",{error:e.toString()},n.sender,{isFailure:!0,requestId:n.id})};var i=n.message;delete n.message,e.extend(n,i),c.on.message.fire(n)}}function _(e){e===c.name&&b()}var x=2e4,R=2e4,N=2e3,O=1,w=2,S=3,T=n.localStorageImpl,D=e.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}}),j=null;Object.defineProperty(c,"_localSyncNode",{get:function(){return j}});var B=null;e.fake&&(c.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),c._syncNodes.mapToClass(D),c._changes.mapToClass(a),j=new D({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),c.Version.prototype._parseStoresSpec=r(c.Version.prototype._parseStoresSpec,function(e){return function(n,t){n._changes="++rev",n._syncNodes="++id,myRevision,lastHeartBeat,url,isMaster,type,status",n._intercomm="++id,destinationNode",n._uncommittedChanges="++id,node",e.call(this,n,t),Object.keys(t).forEach(function(e){var n=t[e];0===n.primKey.name.indexOf("$$")&&(n.primKey.uuid=!0,n.primKey.name=n.primKey.name.substr(2),n.primKey.keyPath=n.primKey.keyPath.substr(2))}),Object.keys(t).forEach(function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(t[e].observable=!0)})}}),c._tableFactory=r(c._tableFactory,function(e){return function(n,t,i){var o=e.apply(this,arguments);return o.schema.observable&&i===c._transPromiseFactory&&d(o),"_syncNodes"===o.name&&i===c._transPromiseFactory&&o.mapToClass(D),o}}),c.on.addEventType({changes:"asap",cleanup:[i,t],message:"asap"}),c._createTransaction=r(c._createTransaction,function(e){return function(n,t,i,o){if(c.dynamicallyOpened())return e.apply(this,arguments);var a=!1;"readwrite"===n&&t.some(function(e){return i[e]&&i[e].observable})&&(a=!0,t=t.slice(0),-1===t.indexOf("_changes")&&t.push("_changes"));var r=e.call(this,n,t,i,o);return a&&(r._lastWrittenRevision=0,r.on("complete",function(){if(r._lastWrittenRevision)if(o){var e=function n(e){return e.parent?n(e.parent):e}(o);e._lastWrittenRevision=Math.max(r._lastWrittenRevision,e.lastWrittenRevision||0)}else u.timeoutHandle&&clearTimeout(u.timeoutHandle),u.timeoutHandle=setTimeout(function(){delete u.timeoutHandle,u(r._lastWrittenRevision)},25)}),r.parent&&r.parent.source&&(r.source=r.parent.source)),r}}),n.latestRevision[c.name]=n.latestRevision[c.name]||0,c.close=r(c.close,function(e){return function(){return c.dynamicallyOpened()?e.apply(this,arguments):(u.timeoutHandle&&(clearTimeout(u.timeoutHandle),delete u.timeoutHandle),n.on("latestRevisionIncremented").unsubscribe(m),n.on("suicideNurseCall").unsubscribe(h),n.on("intercomm").unsubscribe(_),n.on("beforeunload").unsubscribe(p),j&&j.id&&(n.on.suicideNurseCall.fire(c.name,j.id),T.setItem("Dexie.Observable/deadnode:"+j.id.toString()+"/"+c.name,"dead"),j.deleteTimeStamp=1,j.lastHeartBeat=0,c._syncNodes.put(j),j=null),B&&clearTimeout(B),B=null,e.apply(this,arguments))}}),c["delete"]=r(c["delete"],function(e){return function(){return e.apply(this,arguments).then(function(e){return n.latestRevision[c.name]=0,e})}}),c.on("ready",function(){return c.dynamicallyOpened()?c:c.table("_changes").orderBy("rev").last(function(t){var i=t?t.rev:0;return j=new D({myRevision:i,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),n.latestRevision[c.name]<i&&(n.latestRevision[c.name]=i,e.ignoreTransaction(function(){n.on.latestRevisionIncremented.fire(i)})),c.transaction("rw","_syncNodes",function(){c._syncNodes.where("isMaster").equals(1).count(function(e){e||(j.isMaster=1),c._syncNodes.add(j).then(function(){n.on("latestRevisionIncremented",m),n.on("beforeunload",p),n.on("suicideNurseCall",h),n.on("intercomm",_),B=setTimeout(v,N)})})}).then(function(){y()})})},!0);var I=0,C={};c.sendMessage=function(t,i,o,a){if(!j)return s.reject("Database closed");a=a||{};var r={message:i,destinationNode:o,sender:j.id,type:t};e.extend(r,a);var l=["_intercomm"];return a.wantReply&&l.push("_syncNodes"),c.transaction("rw?",l,function(){function t(t){return c._intercomm.add(t).then(function(t){return T.setItem("Dexie.Observable/intercomm/"+c.name,t.toString()),e.ignoreTransaction(function(){n.on.intercomm.fire(c.name)}),a.wantReply?new s(function(e,n){C[t.toString()]={resolve:e,reject:n}}):void 0})}return a.wantReply?c._syncNodes.where("id").equals(o).count(function(e){return e?t(r):c._syncNodes.where("isMaster").above(0).first(function(e){return r.destinationNode=e.id,t(r)})}):void t(r)})},c.broadcastMessage=function(e,n,t){if(!j)return s.reject("Database closed");var i=j.id;c._syncNodes.each(function(o){"local"!==o.type||!t&&o.id===i||c.sendMessage(e,n,o.id)})},c.observable={},c.observable.SyncNode=D}function t(){}function i(e,n){return e===t?n:function(){var t=e.apply(this,arguments);if(t&&"function"==typeof t.then){var i=this,o=arguments;return t.then(function(){return n.apply(i,o)})}return n.apply(this,arguments)}}e="default"in e?e["default"]:e;var o=self,a=e.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),r=e.override,s=e.Promise,l=!1;return n.latestRevision={},n.on=e.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),n.createUUID=function(){var e=Date.now(),n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:7&t|8).toString(16)});return n},n.deleteOldChanges=function(e){e._syncNodes.orderBy("myRevision").first(function(t){var i=Date.now()+300,o=!1;e._changes.where("rev").below(t.myRevision).until(function(){return o=Date.now()>i})["delete"]().then(function(){o&&setTimeout(function(){n.deleteOldChanges(e)},10)})})},n._onStorage=function(t){if(0===t.key.indexOf("Dexie.Observable/")){var i=t.key.split("/"),o=i[1],a=i[2];if("latestRevision"===o){var r=parseInt(t.newValue,10);!isNaN(r)&&r>n.latestRevision[a]&&(n.latestRevision[a]=r,e.ignoreTransaction(function(){n.on("latestRevisionIncremented").fire(a,r)}))}else if(0===o.indexOf("deadnode:")){var s=parseInt(o.split(":")[1],10);t.newValue&&n.on.suicideNurseCall.fire(a,s)}else"intercomm"===o&&t.newValue&&n.on.intercomm.fire(a)}},n._onBeforeUnload=function(){n.on.beforeunload.fire()},n.localStorageImpl=o.localStorage,o.addEventListener&&(o.addEventListener("storage",n._onStorage),o.addEventListener("beforeunload",n._onBeforeUnload)),e.Observable=n,e.addons.push(n),n});
//# sourceMappingURL=dist/dexie-observable.min.js.map